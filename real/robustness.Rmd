---
title: Robustness to clustering in the workflow-processed data 
author: Aaron Lun
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc_float: true
---    

```{r, echo=FALSE}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

# Setup 

This document assesses the robustness of deconvolution to pre-clustering, using the processed `SingleCellExperiment` objects from the `r Biocpkg("simpleSingleCell")` workflow.
Those workflows need to be compiled first, see this [repository](https://github.com/MarioniLab/simpleSingleCellResults) for details.

```{r}
library(scran)
library(scater)
set.seed(10000)

# Change according to the workflow location on your machine:
dir <- "~/AaronDocs/Research/simpleSingleCell/package/vignettes/"
```

We evaluate the sensitivity of the computed size factors to the clustering, simply by requesting more or less refined clusters.

# Brain 

Loading:

```{r}
sce <- readRDS(file.path(dir, "brain_data.rds"))
```

Performing normalization with different types of clustering:

```{r}
clust1 <- quickCluster(sce, pc.approx=TRUE)
sf1 <- computeSumFactors(sce, min.mean=0.1, cluster=clust1, sf.out=TRUE)

clust2 <- quickCluster(sce, pc.approx=TRUE, k=20)
sf2 <- computeSumFactors(sce, min.mean=0.1, cluster=clust2, sf.out=TRUE)
cor(log(sf1), log(sf2))
exp(quantile(p=0.99,abs(log(sf1/sf2))))

clust3 <- quickCluster(sce, pc.approx=TRUE, min.size=40)
sf3 <- computeSumFactors(sce, cluster=clust3, min.mean=0.1, sf.out=TRUE)
cor(log(sf1), log(sf3))
exp(quantile(p=0.99,abs(log(sf1/sf3))))
```

And for comparison, we use library size normalization:

```{r}
lsf <- librarySizeFactors(sce)
cor(log(lsf), log(sf1))
exp(quantile(p=0.99,abs(log(sf1/lsf))))
```

```{r, echo=FALSE, results="hide"}
gc()
```

# PBMC 

Loading:

```{r}
sce <- readRDS(file.path(dir, "pbmc_data.rds"))
```

Performing normalization with different types of clustering:

```{r}
clust1 <- quickCluster(sce, pc.approx=TRUE)
sf1 <- computeSumFactors(sce, min.mean=0.1, cluster=clust1, sf.out=TRUE)

clust2 <- quickCluster(sce, pc.approx=TRUE, k=20)
sf2 <- computeSumFactors(sce, min.mean=0.1, cluster=clust2, sf.out=TRUE)
cor(log(sf1), log(sf2))
exp(quantile(p=0.99,abs(log(sf1/sf2))))

clust3 <- quickCluster(sce, pc.approx=TRUE, min.size=40)
sf3 <- computeSumFactors(sce, cluster=clust3, min.mean=0.1, sf.out=TRUE)
cor(log(sf1), log(sf3))
exp(quantile(p=0.99,abs(log(sf1/sf3))))
```

For comparison, we use library size normalization:

```{r}
lsf <- librarySizeFactors(sce)
cor(log(lsf), log(sf1))
exp(quantile(p=0.99,abs(log(sf1/lsf))))
```

```{r, echo=FALSE, results="hide"}
gc()
```

# Mammary gland 

Loading:

```{r}
sce <- readRDS(file.path(dir, "mammary.rds"))
```

Performing normalization with different types of clustering:

```{r}
clust1 <- quickCluster(sce, pc.approx=TRUE)
sf1 <- computeSumFactors(sce, min.mean=0.1, cluster=clust1, sf.out=TRUE)

clust2 <- quickCluster(sce, pc.approx=TRUE, k=20)
sf2 <- computeSumFactors(sce, min.mean=0.1, cluster=clust2, sf.out=TRUE)
cor(log(sf1), log(sf2))
exp(quantile(p=0.99,abs(log(sf1/sf2))))

clust3 <- quickCluster(sce, pc.approx=TRUE, min.size=40)
sf3 <- computeSumFactors(sce, cluster=clust3, min.mean=0.1, sf.out=TRUE)
cor(log(sf1), log(sf3))
exp(quantile(p=0.99,abs(log(sf1/sf3))))
```

For comparison, we use library size normalization:

```{r}
lsf <- librarySizeFactors(sce)
cor(log(lsf), log(sf1))
exp(quantile(p=0.99,abs(log(sf1/lsf))))
```

# Concluding remarks

We generally observe that strong correlations between size factor estimates with different numbers of clusters, higher than those between the size factors and the library size.
This is consistent with the robustness of the method to DE within each set of cells used for deconvolution.
Only the PBMC data set is a bit aberrant due to the presence of several small clusters with many DE genes.

# Session info

```{r}
sessionInfo()
```

